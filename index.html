<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•½í’ˆ ì¶©ì§„ ì²´í¬ ì‹œìŠ¤í…œ</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 20px; text-align: center; background-color: #f5f5f5; }
        #reader { width: 100%; max-width: 450px; margin: auto; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: white; }
        .status-box { padding: 25px; margin: 15px 0; border: 3px solid #ccc; font-size: 1.4rem; border-radius: 15px; line-height: 1.5; background: white; min-height: 100px; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: all 0.3s ease; }
        
        /* ë‹¨ê³„ë³„ ìƒ‰ìƒ ì •ì˜ */
        .step-1 { border-color: #2196F3; background-color: #f0f7ff; color: #0d47a1; } /* ì•½í’ˆì¥ ëŒ€ê¸° */
        .step-2 { border-color: #FFC107; background-color: #FFFDE7; color: #827717; } /* ì•½ ìŠ¤ìº” ëŒ€ê¸° */
        .match { background-color: #4CAF50 !important; color: white !important; border-color: #2e7d32 !important; }
        .error { background-color: #f44336 !important; color: white !important; border-color: #c62828 !important; }
        
        #medicine-name { font-size: 2.2rem; color: #e64a19; display: block; margin-top: 10px; font-weight: 900; background: #fff; padding: 5px 15px; border-radius: 10px; border: 2px solid #FFC107; }
        h2 { color: #333; margin: 5px 0; }
    </style>
</head>
<body>

    <h2>ğŸ’Š ì•½í’ˆ ì¶©ì§„ ì²´í¬</h2>
    <div id="status" class="status-box">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="reader"></div>

    <script>
        let db = []; 
        let currentStep = 1; 
        let targetData = null;
        let html5QrCode = null;

        async function loadExcel() {
            try {
                const response = await fetch('Master.xlsx'); 
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                db = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                updateStatus("1ë‹¨ê³„: ì•½í’ˆì¥ ë°”ì½”ë“œë¥¼ ì°ìœ¼ì„¸ìš”.", "step-1");
            } catch (e) {
                updateStatus("Master.xlsx íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
            }
        }

        function extractCode(rawText) {
            const key = "01088";
            const index = rawText.indexOf(key);
            if (index !== -1) {
                return rawText.substring(index + key.length, index + key.length + 11);
            }
            return rawText.trim();
        }

        function onScanSuccess(decodedText) {
            // ìŠ¤ìº”ë˜ìë§ˆì ì¦‰ì‹œ ì •ì§€
            html5QrCode.pause();

            if (currentStep === 1) {
                // --- 1ë‹¨ê³„: ì•½í’ˆì¥ ì¸ì‹ ì„±ê³µ ---
                targetData = db.find(item => String(item.ì•½í’ˆì½”ë“œ) === decodedText);

                if (targetData) {
                    // ì•½ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ë©° 'ì¤€ë¹„ ìƒíƒœ'ë¡œ ë³€ê²½
                    const msg = `[ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ]<br>ê°€ì ¸ì˜¬ ì•½: <span id="medicine-name">${targetData.ì•½í’ˆëª…}</span><br>ì ì‹œ í›„ ìŠ¤ìºë„ˆê°€ ì¼œì§‘ë‹ˆë‹¤...`;
                    updateStatus(msg, "step-2");
                    
                    // 1.5ì´ˆ ëŒ€ê¸° í›„ ì•½í’ˆ ìŠ¤ìº” ëª¨ë“œë¡œ ì „í™˜
                    setTimeout(() => {
                        updateStatus(`[${targetData.ì•½í’ˆëª…}]<br>ì•½í’ˆ ë°”ì½”ë“œë¥¼ ì°ìœ¼ì„¸ìš”.`, "step-2");
                        currentStep = 2;
                        html5QrCode.resume(); // ì´ì œ ì•½ ì°ìœ¼ë¼ê³  ìŠ¤ìºë„ˆ ì¼œì¤Œ
                    }, 1500); 
                } else {
                    updateStatus("ë“±ë¡ë˜ì§€ ì•Šì€ ì•½í’ˆì¥ì…ë‹ˆë‹¤.", "error");
                    setTimeout(() => { 
                        updateStatus("1ë‹¨ê³„: ì•½í’ˆì¥ ë°”ì½”ë“œë¥¼ ì°ìœ¼ì„¸ìš”.", "step-1");
                        html5QrCode.resume(); 
                    }, 2000);
                }
            } else if (currentStep === 2) {
                // --- 2ë‹¨ê³„: ì•½í’ˆ ëŒ€ì¡° ---
                const scannedCode = extractCode(decodedText);
                const isMatch = (
                    String(targetData.í‘œì¤€ì½”ë“œ1) === scannedCode ||
                    String(targetData.í‘œì¤€ì½”ë“œ2) === scannedCode ||
                    String(targetData.í‘œì¤€ì½”ë“œ3) === scannedCode
                );

                if (isMatch) {
                    updateStatus(`âœ… ì¼ì¹˜í•©ë‹ˆë‹¤!<br>${targetData.ì•½í’ˆëª…}`, "match");
                    window.navigator.vibrate(100);
                } else {
                    updateStatus(`âŒ ë¶ˆì¼ì¹˜!<br>ë‹¤ë¥¸ ì•½ì…ë‹ˆë‹¤.`, "error");
                    window.navigator.vibrate([200, 100, 200]);
                }

                setTimeout(() => {
                    resetStep();
                    html5QrCode.resume();
                }, 3000);
            }
        }

        function updateStatus(msg, className) {
            const el = document.getElementById('status');
            el.innerHTML = msg;
            el.className = "status-box " + className;
        }

        function resetStep() {
            currentStep = 1;
            targetData = null;
            updateStatus("1ë‹¨ê³„: ì•½í’ˆì¥ ë°”ì½”ë“œë¥¼ ì°ìœ¼ì„¸ìš”.", "step-1");
        }

        window.onload = () => {
            html5QrCode = new Html5QrcodeScanner("reader", { 
                fps: 10, 
                qrbox: { width: 280, height: 200 },
                formatsToSupport: [ 
                    Html5QrcodeSupportedFormats.DATA_MATRIX, 
                    Html5QrcodeSupportedFormats.CODE_39 
                ]
            });
            html5QrCode.render(onScanSuccess);
            loadExcel();
        };
    </script>
</body>
</html>
