<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•½í’ˆ ì¶©ì§„ ì²´í¬ ì‹œìŠ¤í…œ</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 20px; text-align: center; background-color: #f5f5f5; }
        #reader { width: 100%; max-width: 450px; margin: auto; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: white; }
        .status-box { padding: 25px; margin: 15px 0; border: 3px solid #ccc; font-size: 1.4rem; border-radius: 15px; line-height: 1.5; background: white; min-height: 80px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .step-active { border-color: #2196F3; background-color: #f0f7ff; color: #0d47a1; font-weight: bold; }
        .match { background-color: #4CAF50 !important; color: white !important; border-color: #2e7d32 !important; }
        .error { background-color: #f44336 !important; color: white !important; border-color: #c62828 !important; }
        #medicine-name { font-size: 2.2rem; color: #ff5722; display: block; margin-top: 10px; font-weight: 900; background: #fff3e0; padding: 5px 15px; border-radius: 10px; }
        h2 { color: #333; margin-bottom: 5px; }
        .hint { font-size: 0.9rem; color: #666; margin-bottom: 15px; }
    </style>
</head>
<body>

    <h2>ğŸ’Š ì•½í’ˆ ì¶©ì§„ ì²´í¬</h2>
    <div class="hint">Master.xlsx íŒŒì¼ì„ ì½ì–´ ìë™ìœ¼ë¡œ ëŒ€ì¡°í•©ë‹ˆë‹¤.</div>
    
    <div id="status" class="status-box">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    
    <div id="reader"></div>

    <script>
        let db = []; 
        let currentStep = 1; // 1: ì•½í’ˆì¥ ìŠ¤ìº”, 2: ì•½í’ˆ ìŠ¤ìº”
        let targetData = null;
        let html5QrCode = null;

        // [1. ì—‘ì…€ ë¡œë“œ í•¨ìˆ˜]
        async function loadExcel() {
            try {
                const response = await fetch('Master.xlsx'); 
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                // ì²« ë²ˆì§¸ ì‹œíŠ¸ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
                db = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                updateStatus("1ë‹¨ê³„: ì•½í’ˆì¥ ë°”ì½”ë“œë¥¼ ì°ìœ¼ì„¸ìš”.", "step-active");
            } catch (e) {
                updateStatus("Master.xlsx íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>íŒŒì¼ì´ ì„œë²„ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.", "error");
            }
        }

        // [2. ë°”ì½”ë“œ ë²ˆí˜¸ ì¶”ì¶œ (01088 ë’¤ 11ìë¦¬)]
        function extractCode(rawText) {
            const key = "01088";
            const index = rawText.indexOf(key);
            if (index !== -1) {
                // 01088 ë°”ë¡œ ë‹¤ìŒë¶€í„° 11ê¸€ìë§Œ ì˜ë¼ëƒ„
                return rawText.substring(index + key.length, index + key.length + 11);
            }
            return rawText.trim(); // ì—†ìœ¼ë©´ ê·¸ëƒ¥ ê³µë°±ì œê±° í›„ ë°˜í™˜
        }

        // [3. ìŠ¤ìº” ì„±ê³µ ì‹œ ì‹¤í–‰ë˜ëŠ” í•µì‹¬ ë¡œì§]
        function onScanSuccess(decodedText) {
            // ì¤‘ë³µ ìŠ¤ìº” ë°©ì§€: íŒë…í•˜ëŠ” ë™ì•ˆ ìŠ¤ìºë„ˆ ì¼ì‹œ ì •ì§€
            html5QrCode.pause();

            if (currentStep === 1) {
                // --- 1ë‹¨ê³„: ì•½í’ˆì¥ í™•ì¸ ---
                targetData = db.find(item => String(item.ì•½í’ˆì½”ë“œ) === decodedText);

                if (targetData) {
                    const msg = `ë‹¤ìŒ ì•½ì„ ë„£ìœ¼ì„¸ìš”:<br><span id="medicine-name">${targetData.ì•½í’ˆëª…}</span>`;
                    updateStatus(msg, "step-active");
                    currentStep = 2;
                    // ìœ„ì¹˜ í™•ì¸ í›„ ë°”ë¡œ ë‹¤ìŒ ìŠ¤ìº” ì¤€ë¹„
                    setTimeout(() => { html5QrCode.resume(); }, 500); 
                } else {
                    updateStatus("ë“±ë¡ë˜ì§€ ì•Šì€ ì•½í’ˆì¥ì…ë‹ˆë‹¤.", "error");
                    setTimeout(() => { 
                        updateStatus("1ë‹¨ê³„: ì•½í’ˆì¥ ë°”ì½”ë“œë¥¼ ì°ìœ¼ì„¸ìš”.", "step-active");
                        html5QrCode.resume(); 
                    }, 2000);
                }
            } else if (currentStep === 2) {
                // --- 2ë‹¨ê³„: ì•½í’ˆ ëŒ€ì¡° ---
                const scannedCode = extractCode(decodedText);
                
                // í‘œì¤€ì½”ë“œ 1, 2, 3 ì¤‘ í•˜ë‚˜ë¼ë„ ë§ëŠ”ì§€ ì²´í¬
                const isMatch = (
                    String(targetData.í‘œì¤€ì½”ë“œ1) === scannedCode ||
                    String(targetData.í‘œì¤€ì½”ë“œ2) === scannedCode ||
                    String(targetData.í‘œì¤€ì½”ë“œ3) === scannedCode
                );

                if (isMatch) {
                    updateStatus(`âœ… ì¼ì¹˜í•©ë‹ˆë‹¤!<br>${targetData.ì•½í’ˆëª…}`, "match");
                    window.navigator.vibrate(100);
                } else {
                    updateStatus(`âŒ ë¶ˆì¼ì¹˜!<br>ë‹¤ë¥¸ ì•½ì…ë‹ˆë‹¤.`, "error");
                    window.navigator.vibrate([200, 100, 200]);
                }

                // ê²°ê³¼ ë³´ì—¬ì¤€ ë’¤ 3ì´ˆ í›„ì— ì²˜ìŒ ìƒíƒœë¡œ ë¦¬ì…‹
                setTimeout(() => {
                    resetStep();
                    html5QrCode.resume();
                }, 3000);
            }
        }

        // ìƒíƒœì°½ ë¬¸êµ¬ ë° ë””ìì¸ ë³€ê²½ í•¨ìˆ˜
        function updateStatus(msg, className) {
            const el = document.getElementById('status');
            el.innerHTML = msg;
            el.className = "status-box " + className;
        }

        function resetStep() {
            currentStep = 1;
            targetData = null;
            updateStatus("1ë‹¨ê³„: ì•½í’ˆì¥ ë°”ì½”ë“œë¥¼ ì°ìœ¼ì„¸ìš”.", "step-active");
        }

        // [4. ìŠ¤ìºë„ˆ ë° ì—‘ì…€ ì´ˆê¸°í™” ì‹œì‘]
        window.onload = () => {
            html5QrCode = new Html5QrcodeScanner("reader", { 
                fps: 10, // ìŠ¤ìº” ì†ë„ë¥¼ ì•½ê°„ ëŠ¦ì¶°ì„œ ì•ˆì •ê° ìˆê²Œ ì¡°ì ˆ
                qrbox: { width: 280, height: 200 },
                formatsToSupport: [ 
                    Html5QrcodeSupportedFormats.DATA_MATRIX, 
                    Html5QrcodeSupportedFormats.CODE_39 
                ]
            });
            html5QrCode.render(onScanSuccess);
            loadExcel();
        };
    </script>
</body>
</html>
