<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•½í’ˆ í¬ë¡œìŠ¤ì²´í¬</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; text-align: center; }
        #reader { width: 100%; max-width: 450px; margin: auto; border-radius: 15px; overflow: hidden; }
        .status-box { padding: 25px; margin: 15px 0; border: 3px solid #ccc; font-size: 1.4rem; border-radius: 15px; line-height: 1.5; }
        .step-active { border-color: #2196F3; background-color: #f0f7ff; color: #0d47a1; }
        .match { background-color: #4CAF50; color: white; border-color: #2e7d32; }
        .error { background-color: #f44336; color: white; border-color: #c62828; }
        #medicine-name { font-size: 2rem; color: #ff5722; display: block; margin-top: 10px; font-weight: 900; }
    </style>
</head>
<body>

    <h2>ğŸ’Š ì•½í’ˆ ì¶©ì§„ ì²´í¬</h2>
    
    <div id="status" class="status-box">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    
    <div id="reader"></div>

    <script>
        let db = []; 
        let currentStep = 1; // 1: ì•½í’ˆì¥(ìœ„ì¹˜) ìŠ¤ìº”, 2: ì•½í’ˆ ìŠ¤ìº”
        let targetData = null;

        // [ì„œë²„ì—ì„œ ì—‘ì…€ ë¡œë“œ]
        async function loadExcel() {
            try {
                const response = await fetch('Master.xlsx'); // íŒŒì¼ëª…ì„ Master.xlsxë¡œ ë§ì¶°ì£¼ì„¸ìš”.
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                db = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                document.getElementById('status').innerText = "1ë‹¨ê³„: ì•½í’ˆì¥ ë°”ì½”ë“œë¥¼ ì°ìœ¼ì„¸ìš”.";
                document.getElementById('status').className = "status-box step-active";
            } catch (e) {
                document.getElementById('status').innerText = "Master.xlsx íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
        }
        loadExcel();

        // [ë°ì´í„° ë§¤íŠ¸ë¦­ìŠ¤ ë²ˆí˜¸ ì¶”ì¶œê¸°]
        function extractCode(rawText) {
            // "01088" ìœ„ì¹˜ë¥¼ ì°¾ê³  ê·¸ ë’¤ì˜ 11ìë¦¬ë¥¼ ê°€ì ¸ì˜´
            const key = "01088";
            const index = rawText.indexOf(key);
            if (index !== -1) {
                return rawText.substring(index + key.length, index + key.length + 11);
            }
            return rawText; // 01088ì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì›ë³¸ ë°˜í™˜ (Code39 ëŒ€ë¹„)
        }

        function onScanSuccess(decodedText) {
            if (db.length === 0) return;

            if (currentStep === 1) {
                // 1ë‹¨ê³„: ì•½í’ˆì¥ ìŠ¤ìº” (ì•½í’ˆì½”ë“œ ì»¬ëŸ¼ê³¼ ë¹„êµ)
                targetData = db.find(item => String(item.ì•½í’ˆì½”ë“œ) === decodedText);

                if (targetData) {
                    document.getElementById('status').innerHTML = 
                        `ë‹¤ìŒ ì•½ì„ ë„£ìœ¼ì„¸ìš”:<br><span id="medicine-name">${targetData.ì•½í’ˆëª…}</span>`;
                    currentStep = 2;
                } else {
                    showResult("ë“±ë¡ë˜ì§€ ì•Šì€ ì•½í’ˆì¥ì…ë‹ˆë‹¤.", "error");
                }
            } else if (currentStep === 2) {
                // 2ë‹¨ê³„: ì•½í’ˆ ìŠ¤ìº” ë° ë¹„êµ
                const scannedCode = extractCode(decodedText);
                
                // í‘œì¤€ì½”ë“œ 1, 2, 3 ì¤‘ í•˜ë‚˜ë¼ë„ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                const isMatch = (
                    String(targetData.í‘œì¤€ì½”ë“œ1) === scannedCode ||
                    String(targetData.í‘œì¤€ì½”ë“œ2) === scannedCode ||
                    String(targetData.í‘œì¤€ì½”ë“œ3) === scannedCode
                );

                if (isMatch) {
                    showResult(`âœ… ì¼ì¹˜!<br>${targetData.ì•½í’ˆëª…}`, "match");
                } else {
                    showResult(`âŒ ë¶ˆì¼ì¹˜!<br>ë‹¤ë¥¸ ì•½ì…ë‹ˆë‹¤.`, "error");
                }
                setTimeout(resetStep, 3000);
            }
        }

        function showResult(msg, className) {
            const el = document.getElementById('status');
            el.innerHTML = msg;
            el.className = "status-box " + className;
            if (className === 'error') window.navigator.vibrate([200, 100, 200]);
        }

        function resetStep() {
            currentStep = 1;
            targetData = null;
            document.getElementById('status').innerText = "1ë‹¨ê³„: ì•½í’ˆì¥ ë°”ì½”ë“œë¥¼ ì°ìœ¼ì„¸ìš”.";
            document.getElementById('status').className = "status-box step-active";
        }

        const scanner = new Html5QrcodeScanner("reader", { 
            fps: 20, qrbox: 280,
            formatsToSupport: [ 
                Html5QrcodeSupportedFormats.DATA_MATRIX, 
                Html5QrcodeSupportedFormats.CODE_39 
            ]
        });
        scanner.render(onScanSuccess);
    </script>
</body>
</html>
