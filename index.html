<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•½í’ˆ ì¶©ì§„ ì²´í¬ ì‹œìŠ¤í…œ</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 20px; text-align: center; background-color: #f5f5f5; }
        #reader { width: 100%; max-width: 450px; margin: auto; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: white; }
        .status-box { padding: 20px; margin: 15px 0; border: 3px solid #ccc; font-size: 1.3rem; border-radius: 15px; line-height: 1.4; background: white; min-height: 150px; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: all 0.2s ease; }
        
        .step-1 { border-color: #2196F3; background-color: #f0f7ff; color: #0d47a1; } 
        .step-2 { border-color: #FFC107; background-color: #FFFDE7; color: #827717; } 
        .match { background-color: #4CAF50 !important; color: white !important; border-color: #2e7d32 !important; }
        .error { background-color: #f44336 !important; color: white !important; border-color: #c62828 !important; }
        
        #medicine-name { font-size: 1.8rem; color: #e64a19; display: block; margin-top: 5px; font-weight: 900; background: #fff; padding: 5px 10px; border-radius: 10px; border: 2px solid #FFC107; }
        .med-image { width: 100%; max-width: 250px; height: auto; margin-top: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); background-color: white; }
        .reset-btn { margin-top: 15px; padding: 10px 20px; font-size: 1rem; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; background: white; }
    </style>
</head>
<body>

    <h2>ğŸ’Š ì•½í’ˆ ì¶©ì§„ ì²´í¬ (Photo Ver.)</h2>
    <div id="status" class="status-box">ë°ì´í„° ë¡œë”© ì¤‘...</div>
    <div id="reader"></div>
    <button class="reset-btn" onclick="resetStep()">ğŸ”„ ì²˜ìŒë¶€í„° (ë¦¬ì…‹)</button>

    <script>
        let db = []; 
        let currentStep = 1; 
        let targetData = null;
        let html5QrCode = null;

        async function loadExcel() {
            try {
                // Master.xlsx íŒŒì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const response = await fetch('Master.xlsx'); 
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                db = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                updateStatus("1ë‹¨ê³„: ì•½í’ˆì¥ ë°”ì½”ë“œ(Code39)ë¥¼ ì°ìœ¼ì„¸ìš”.", "step-1");
            } catch (e) {
                updateStatus("Master.xlsx íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
            }
        }

        function extractCode(rawText) {
            const key = "01088";
            const index = rawText.indexOf(key);
            if (index !== -1) {
                return rawText.substring(index + key.length, index + key.length + 11);
            }
            return rawText.trim();
        }

        // [ì´ë¯¸ì§€ í¬í•¨ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜]
        function updateStatusWithImage(msg, className, medicineCode = null) {
            const el = document.getElementById('status');
            let imageHtml = "";
            
            if (medicineCode) {
                // images í´ë” ë‚´ì˜ ì•½í’ˆì½”ë“œ.gif íŒŒì¼ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
                // ì´ë¯¸ì§€ê°€ ì—†ì„ ê²½ìš°(onerror) ì•„ì˜ˆ í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                imageHtml = `<img src="images/${medicineCode}.gif" class="med-image" onerror="this.style.display='none'">`;
            }
            
            el.innerHTML = `${msg}${imageHtml}`;
            el.className = "status-box " + className;
        }

        function onScanSuccess(decodedText, decodedResult) {
            html5QrCode.pause();

            // Code39 í˜•ì‹ì€ ì•½í’ˆì¥ ë°”ì½”ë“œë¡œ ì¸ì‹
            const isShelfBarcode = decodedResult.result.format.formatName === "CODE_39";

            if (isShelfBarcode) {
                const found = db.find(item => String(item.ì•½í’ˆì½”ë“œ) === decodedText);
                if (found) {
                    targetData = found;
                    currentStep = 2;
                    const msg = `[ìœ„ì¹˜ í™•ì¸]<br><span id="medicine-name">${targetData.ì•½í’ˆëª…}</span>`;
                    updateStatusWithImage(msg, "step-2", targetData.ì•½í’ˆì½”ë“œ);
                    
                    setTimeout(() => { html5QrCode.resume(); }, 1500);
                } else {
                    updateStatusWithImage("ë“±ë¡ë˜ì§€ ì•Šì€ ì•½í’ˆì¥ì…ë‹ˆë‹¤.", "error");
                    setTimeout(() => { resetStep(); html5QrCode.resume(); }, 2000);
                }
                return;
            }

            // 2ë‹¨ê³„: ì•½í’ˆ ëŒ€ì¡°
            if (currentStep === 2) {
                const scannedCode = extractCode(decodedText);
                const isMatch = (
                    String(targetData.í‘œì¤€ì½”ë“œ1) === scannedCode ||
                    String(targetData.í‘œì¤€ì½”ë“œ2) === scannedCode ||
                    String(targetData.í‘œì¤€ì½”ë“œ3) === scannedCode
                );

                if (isMatch) {
                    updateStatusWithImage(`âœ… ì¼ì¹˜í•©ë‹ˆë‹¤!<br>${targetData.ì•½í’ˆëª…}`, "match", targetData.ì•½í’ˆì½”ë“œ);
                    window.navigator.vibrate(100);
                } else {
                    updateStatusWithImage(`âŒ ë¶ˆì¼ì¹˜! ë‹¤ë¥¸ ì•½ì…ë‹ˆë‹¤.`, "error", targetData.ì•½í’ˆì½”ë“œ);
                    window.navigator.vibrate([200, 100, 200]);
                }

                setTimeout(() => {
                    const msg = `[ì—°ì† ìŠ¤ìº” ëª¨ë“œ]<br><span id="medicine-name">${targetData.ì•½í’ˆëª…}</span><br>ë‹¤ìŒ ì•½ì„ ì°ìœ¼ì„¸ìš”.`;
                    updateStatusWithImage(msg, "step-2", targetData.ì•½í’ˆì½”ë“œ);
                    html5QrCode.resume();
                }, 1500);
            } else {
                updateStatusWithImage("ë¨¼ì € ì•½í’ˆì¥ ë°”ì½”ë“œë¶€í„° ì°ìœ¼ì„¸ìš”.", "error");
                setTimeout(() => { html5QrCode.resume(); }, 1500);
            }
        }

        function updateStatus(msg, className) {
            const el = document.getElementById('status');
            el.innerHTML = msg;
            el.className = "status-box " + className;
        }

        function resetStep() {
            currentStep = 1;
            targetData = null;
            updateStatus("1ë‹¨ê³„: ì•½í’ˆì¥ ë°”ì½”ë“œ(Code39)ë¥¼ ì°ìœ¼ì„¸ìš”.", "step-1");
            if(html5QrCode) html5QrCode.resume();
        }

        window.onload = () => {
            html5QrCode = new Html5QrcodeScanner("reader", { 
                fps: 15, 
                qrbox: { width: 280, height: 200 },
                formatsToSupport: [ 
                    Html5QrcodeSupportedFormats.DATA_MATRIX, 
                    Html5QrcodeSupportedFormats.CODE_39 
                ]
            });
            html5QrCode.render(onScanSuccess);
            loadExcel();
        };
    </script>
</body>
</html>
